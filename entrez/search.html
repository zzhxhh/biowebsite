<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿç‰©ä¿¡æ¯å­¦æœç´¢ - ç®€å•æ•°æ®åº“æ£€ç´¢å·¥å…·</title>
    <meta name="description" content="åŸºäºNCBI Entrez APIçš„ç®€å•ç”Ÿç‰©ä¿¡æ¯å­¦æ•°æ®åº“æœç´¢å·¥å…·ï¼Œæ”¯æŒPubMedã€Geneã€Proteinç­‰æ•°æ®åº“æ£€ç´¢ï¼Œæä¾›åŸºç¡€çš„å¯è§†åŒ–ç»“æœå±•ç¤ºã€‚">

    <!-- å¤–éƒ¨èµ„æº -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Kalam:wght@300;400;700&family=Caveat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <!-- ä¸»ç½‘ç«™æ ·å¼ -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../pet/pixel-cat.css">
    
    <!-- æœç´¢é¡µé¢ä¸“ç”¨æ ·å¼ -->
    <link rel="stylesheet" href="css/search-page.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar" data-aos="fade-down">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-robot"></i>
                <span>ç½‘ç«™å¯¼èˆª</span>
            </div>

            <div class="nav-menu">
                <a href="../index.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    é¦–é¡µ
                </a>

                <a href="../about.html" class="nav-link">
                    <i class="fas fa-info-circle"></i>
                    å…³äºæˆ‘ä»¬
                </a>

                <!-- ç”¨æˆ·èœå• - é€šè¿‡JavaScriptåŠ¨æ€æ§åˆ¶æ˜¾ç¤º -->
                <div id="userMenuLoggedIn" class="user-menu-section" style="display: none;">
                    <a href="../favorites.html" class="nav-link">
                        <i class="fas fa-heart"></i>
                        æˆ‘çš„æ”¶è—
                    </a>
                    <div class="user-menu">
                        <span class="user-name">
                            <i class="fas fa-user"></i>
                            <span id="usernameDisplay"></span>
                        </span>
                        <a href="#" class="nav-link" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            é€€å‡º
                        </a>
                    </div>
                </div>

                <div id="userMenuLoggedOut" class="user-menu-section">
                    <a href="#" class="nav-link" id="loginLink">
                        <i class="fas fa-sign-in-alt"></i>
                        ç™»å½•
                    </a>
                    <a href="#" class="nav-link" id="registerLink">
                        <i class="fas fa-user-plus"></i>
                        æ³¨å†Œ
                    </a>
                </div>

                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="main-content">
        <!-- æœç´¢é¡µé¢å¤´éƒ¨ -->
        <section class="search-hero" data-aos="fade-up">
            <div class="container">
                <h1><i class="fas fa-dna"></i> ç”Ÿç‰©ä¿¡æ¯å­¦æœç´¢</h1>
                <p>åŸºäºNCBI Entrez APIå¼€å‘çš„ç®€å•ç”Ÿç‰©ä¿¡æ¯æ•°æ®åº“æœç´¢å·¥å…·</p>
                <p>æ”¯æŒPubMedæ–‡çŒ®ã€GeneåŸºå› ã€Proteinè›‹ç™½è´¨ç­‰æ•°æ®åº“çš„åŸºç¡€æ£€ç´¢åŠŸèƒ½</p>
            </div>
        </section>

        <!-- æœç´¢åŠŸèƒ½åŒºåŸŸ -->
        <section class="search-section" data-aos="fade-up" data-aos-delay="200">
            <div class="container">
                <div class="search-card">
                    <form id="searchForm">
                        <div class="search-form">
                            <div class="form-group">
                                <label for="database">æ•°æ®åº“</label>
                                <select id="database" name="database">
                                    <option value="pubmed">PubMed (æ–‡çŒ®)</option>
                                    <option value="gene">Gene (åŸºå› )</option>
                                    <option value="protein">Protein (è›‹ç™½è´¨)</option>
                                    <option value="nucleotide">Nucleotide (æ ¸é…¸)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="keyword">æœç´¢å…³é”®è¯</label>
                                <input type="text" id="keyword" name="keyword" placeholder="è¾“å…¥æœç´¢å…³é”®è¯..." required>
                            </div>

                            <div class="form-group">
                                <label for="method">æœç´¢æ–¹å¼</label>
                                <select id="method" name="method">
                                    <option value="get">GET æ–¹å¼</option>
                                    <option value="post">POST æ–¹å¼</option>
                                    <option value="session">SESSION æ–¹å¼</option>
                                </select>
                            </div>
                        </div>

                        <div class="search-buttons">
                            <button type="submit" class="search-btn" id="searchBtn">
                                <i class="fas fa-search"></i> æœç´¢
                            </button>
                                <i class="fas fa-flask"></i> æµ‹è¯•å¯è§†åŒ–
                            </button>
                        </div>
                    </form>

                    <!-- è¿›åº¦æ¡ -->
                    <div class="progress" id="progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">å‡†å¤‡æœç´¢...</div>
                    </div>

                    <!-- åŠ è½½çŠ¶æ€ -->
                    <div class="loading" id="loading">
                        <i class="fas fa-spinner"></i>
                        <p>æ­£åœ¨æœç´¢ï¼Œè¯·ç¨å€™...</p>
                    </div>

                    <!-- æœç´¢ç»“æœ -->
                    <div class="results" id="results">
                        <div class="result-header">
                            <div class="result-count" id="resultCount"></div>
                            <div class="result-controls">
                                <button class="view-toggle-btn active" data-view="list" id="listViewBtn">
                                    <i class="fas fa-list"></i> åˆ—è¡¨è§†å›¾
                                </button>
                                <button class="view-toggle-btn" data-view="chart" id="chartViewBtn">
                                    <i class="fas fa-chart-bar"></i> å¯è§†åŒ–
                                </button>
                            </div>
                        </div>

                        <!-- åˆ—è¡¨è§†å›¾ -->
                        <div id="resultList" class="result-view active"></div>

                        <!-- å¯è§†åŒ–è§†å›¾ -->
                        <div id="chartView" class="result-view chart-container">
                            <div class="simple-charts">
                                <!-- ç¬¬ä¸€ä¸ªå›¾è¡¨ -->
                                <div class="chart-card">
                                    <h3 id="firstChartTitle">ğŸ“Š å¹´ä»½åˆ†å¸ƒ</h3>
                                    <canvas id="yearChart"></canvas>
                                </div>

                                <!-- ç»Ÿè®¡åˆ†å¸ƒå›¾ -->
                                <div class="chart-card">
                                    <h3>ğŸ“ˆ æ•°æ®ç»Ÿè®¡</h3>
                                    <canvas id="statsChart"></canvas>
                                </div>
                            </div>
                        </div>


                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- é¡µè„š -->
    <footer class="footer" data-aos="fade-up">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>ğŸ§¬ ç”Ÿç‰©ä¿¡æ¯å­¦æœç´¢</h3>
                    <p>åŸºäºNCBI Entrez APIçš„ç®€å•ç”Ÿç‰©ä¿¡æ¯æ•°æ®åº“æœç´¢å·¥å…·ï¼Œæä¾›åŸºç¡€çš„æ•°æ®åº“æ£€ç´¢åŠŸèƒ½ã€‚</p>
                </div>
                <div class="footer-section">
                    <h4>ğŸ¯ åŠŸèƒ½ç‰¹è‰²</h4>
                    <ul>
                        <li>ğŸ” å¤šæ•°æ®åº“æ”¯æŒ</li>
                        <li>ğŸ“Š å¯è§†åŒ–ç»“æœå±•ç¤º</li>
                        <li>ğŸš€ ä¸‰ç§æœç´¢æ–¹å¼</li>
                        <li>ğŸ¨ å“åº”å¼è®¾è®¡</li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>ğŸ“Š æŠ€æœ¯å®ç°</h4>
                    <div class="footer-stats">
                        <p>ğŸ› ï¸ å­¦ä¹ é¡¹ç›®</p>
                        <p>ğŸ“‚ NCBI Entrez API</p>
                        <p>ğŸ†• åŸºç¡€æ•°æ®æ£€ç´¢</p>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 ç”Ÿç‰©ä¿¡æ¯å­¦æœç´¢å·¥å…· - å¼ å­è±ªçš„å­¦ä¹ é¡¹ç›® (2330416015). ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨.</p>
            </div>
        </div>
    </footer>

    <!-- çº¯GIFæ¡Œå®  -->
    <div id="pixel-cat-container">
        <div id="pixel-cat-menu" class="pixel-cat-menu">
            <div class="pixel-menu-item" data-action="home">ğŸ  å›åˆ°é¦–é¡µ</div>
            <div class="pixel-menu-item" data-action="top">â¬†ï¸ å›åˆ°é¡¶éƒ¨</div>
            <div class="pixel-menu-item" data-action="focus">ğŸ” èšç„¦æœç´¢æ¡†</div>
            <div class="pixel-menu-item" data-action="theme">ğŸ¨ åˆ‡æ¢ä¸»é¢˜</div>
            <div class="pixel-menu-item" data-action="singing">
                <i class="fas fa-music"></i>
                <span>è®©æˆ‘å”±æ­Œ</span>
            </div>
            <div class="pixel-menu-item" data-action="sleep">ğŸ˜´ ä¼‘æ¯</div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="js/simple-charts.js"></script>

    <script>
        // è®¤è¯ç›¸å…³åŠŸèƒ½ - ä¿æŒåŸæœ‰é€»è¾‘







        // æç®€æœç´¢åº”ç”¨
        class SimpleSearchApp {
            constructor() {
                this.form = document.getElementById('searchForm');
                this.loading = document.getElementById('loading');
                this.results = document.getElementById('results');
                this.visualization = new SimpleVisualization();
                this.init();
            }

            init() {
                this.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSearch();
                });
                this.bindViewToggle();
            }

            bindViewToggle() {
                const listViewBtn = document.getElementById('listViewBtn');
                const chartViewBtn = document.getElementById('chartViewBtn');

                listViewBtn?.addEventListener('click', () => this.switchView('list'));
                chartViewBtn?.addEventListener('click', () => this.switchView('chart'));
            }

            switchView(viewType) {
                const listViewBtn = document.getElementById('listViewBtn');
                const chartViewBtn = document.getElementById('chartViewBtn');
                const resultList = document.getElementById('resultList');
                const chartView = document.getElementById('chartView');

                if (viewType === 'list') {
                    listViewBtn?.classList.add('active');
                    chartViewBtn?.classList.remove('active');
                    resultList?.classList.add('active');
                    chartView?.classList.remove('active');
                } else {
                    listViewBtn?.classList.remove('active');
                    chartViewBtn?.classList.add('active');
                    resultList?.classList.remove('active');
                    chartView?.classList.add('active');
                }
            }

            async handleSearch() {
                const formData = new FormData(this.form);
                const database = formData.get('database');
                const keyword = formData.get('keyword')?.trim();
                const method = formData.get('method');

                if (!keyword) {
                    alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                    return;
                }

                this.showLoading(true);

                try {
                    const results = await this.search(database, keyword, method);
                    this.displayResults(results);
                } catch (error) {
                    this.showError(error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async search(database, keyword, method) {
                const endpoints = {
                    get: 'api/search.php',
                    post: 'api/search_post.php',
                    session: 'api/search_session.php'
                };

                let response;

                if (method === 'get') {
                    const params = new URLSearchParams({
                        db: database,
                        term: keyword,
                        retmax: 20
                    });
                    response = await fetch(`${endpoints.get}?${params}`);
                } else {
                    const formData = new FormData();
                    formData.append('db', database);
                    formData.append('term', keyword);
                    formData.append('retmax', '20');

                    response = await fetch(endpoints[method], {
                        method: 'POST',
                        body: formData,
                        ...(method === 'session' && { credentials: 'include' })
                    });
                }

                if (!response.ok) {
                    throw new Error(`æœç´¢å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'æœç´¢å¤±è´¥');
                }

                return data;
            }

            displayResults(data) {
                const resultCount = document.getElementById('resultCount');
                const resultList = document.getElementById('resultList');

                if (resultCount) {
                    resultCount.textContent = `æ‰¾åˆ° ${data.count} æ¡ç»“æœï¼Œæ˜¾ç¤ºå‰ ${data.details.length} æ¡ (${data.method}æ–¹å¼)`;
                }

                if (resultList) {
                    resultList.innerHTML = '';
                    data.details.forEach(item => {
                        resultList.appendChild(this.createResultItem(item));
                    });
                }

                this.results.style.display = 'block';

                // ç”Ÿæˆç®€å•å›¾è¡¨
                this.visualization.generateCharts(data.database, data.details);
            }

            createResultItem(item) {
                const div = document.createElement('div');
                div.className = 'result-item';

                const title = item.title || 'æ— æ ‡é¢˜';
                const authors = Array.isArray(item.authors) ? item.authors.join(', ') : '';
                const journal = item.journal || '';
                const year = item.year || '';
                const abstract = item.abstract || 'æ— æ‘˜è¦';
                const url = item.url || '#';

                div.innerHTML = `
                    <div class="result-title">
                        <a href="${url}" target="_blank">${title}</a>
                    </div>
                    <div class="result-meta">
                        ${authors ? `ä½œè€…: ${authors}` : ''}
                        ${journal ? ` | æœŸåˆŠ: ${journal}` : ''}
                        ${year ? ` | å¹´ä»½: ${year}` : ''}
                        ${item.pmid ? ` | PMID: ${item.pmid}` : ''}
                    </div>
                    <div class="result-abstract">${abstract}</div>
                `;

                return div;
            }

            showLoading(show) {
                this.loading.style.display = show ? 'block' : 'none';
                const searchBtn = document.getElementById('searchBtn');
                if (searchBtn) searchBtn.disabled = show;
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;

                this.form.appendChild(errorDiv);
                setTimeout(() => errorDiv.remove(), 5000);
            }

            // æµ‹è¯•åŠŸèƒ½
                const mockData = {
                    success: true,
                    database: 'pubmed',
                    method: 'test',
                    count: 20,
                    details: Array.from({length: 20}, (_, i) => ({
                        title: `Test Article ${i + 1}: Machine Learning in Bioinformatics`,
                        year: 2018 + Math.floor(Math.random() * 6),
                        authors: ['Smith J', 'Johnson A', 'Brown K'],
                        journal: 'Nature Biotechnology',
                        abstract: 'This is a sample abstract for testing visualization purposes...',
                        pmid: `12345${i}`,
                        url: '#'
                    }))
                };
                this.displayResults(mockData);
            }
        }

        // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', () => {
            window.bioinfoSearchInstance = new SimpleSearchApp();

            // åˆå§‹åŒ–AOSåŠ¨ç”»
            AOS.init({
                duration: 800,
                easing: 'ease-in-out',
                once: true
            });

            // åˆå§‹åŒ–è®¤è¯ç®¡ç†å™¨
            initAuthManager();

            // ä¿æŒç™»å½•çŠ¶æ€
            checkLoginStatus();

            // å»¶è¿Ÿå†æ¬¡æ£€æŸ¥ï¼ˆç¡®ä¿æ‰€æœ‰è„šæœ¬éƒ½åŠ è½½å®Œæˆï¼‰
            setTimeout(() => {
                console.log('ğŸ”„ å»¶è¿Ÿæ£€æŸ¥ç™»å½•çŠ¶æ€...');
                checkLoginStatus();
            }, 500);

            // æ£€æŸ¥URLå‚æ•°ï¼Œå¦‚æœæ˜¯ä»ç™»å½•é¡µé¢é‡å®šå‘å›æ¥çš„ï¼Œå¼ºåˆ¶åˆ·æ–°çŠ¶æ€
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('from_login') || document.referrer.includes('/auth/')) {
                console.log('ğŸ”„ æ£€æµ‹åˆ°ä»ç™»å½•é¡µé¢è¿”å›ï¼Œå¼ºåˆ¶åˆ·æ–°çŠ¶æ€...');
                setTimeout(() => {
                    checkLoginStatus();
                }, 1000);
            }

            // ç»‘å®šé€€å‡ºç™»å½•äº‹ä»¶
            bindLogoutEvent();

            // ç»‘å®šç™»å½•æ³¨å†Œé“¾æ¥äº‹ä»¶
            bindAuthLinks();

            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            setTimeout(() => {
                console.log('ğŸ” é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥å…ƒç´ ç»‘å®šçŠ¶æ€...');
                const loginLink = document.getElementById('loginLink');
                const registerLink = document.getElementById('registerLink');
                console.log('ç™»å½•é“¾æ¥å…ƒç´ :', loginLink);
                console.log('æ³¨å†Œé“¾æ¥å…ƒç´ :', registerLink);

                if (loginLink) {
                    console.log('âœ… ç™»å½•é“¾æ¥æ‰¾åˆ°');
                    // æ‰‹åŠ¨æµ‹è¯•ç‚¹å‡»äº‹ä»¶
                    loginLink.addEventListener('click', () => {
                        console.log('ğŸ¯ ç™»å½•é“¾æ¥è¢«ç‚¹å‡»ï¼');
                    });
                } else {
                    console.error('âŒ ç™»å½•é“¾æ¥æœªæ‰¾åˆ°');
                }
            }, 1000);

            // ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
            setupLoginStateListener();
        });

        // è®¾ç½®ç™»å½•çŠ¶æ€ç›‘å¬å™¨
        function setupLoginStateListener() {
            // ç›‘å¬localStorageå˜åŒ–
            window.addEventListener('storage', (e) => {
                if (e.key === 'isLoggedIn' || e.key === 'username' || e.key === 'userInfo') {
                    console.log('ğŸ”„ æ£€æµ‹åˆ°ç™»å½•çŠ¶æ€å˜åŒ–ï¼Œé‡æ–°æ£€æŸ¥...');
                    setTimeout(checkLoginStatus, 100);
                }
            });

            // ç›‘å¬è‡ªå®šä¹‰ç™»å½•äº‹ä»¶
            window.addEventListener('loginStateChanged', (e) => {
                console.log('ğŸ”„ æ”¶åˆ°ç™»å½•çŠ¶æ€å˜åŒ–äº‹ä»¶:', e.detail);
                setTimeout(checkLoginStatus, 100);
            });

            // å®šæœŸæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆé˜²æ­¢æŸäº›æƒ…å†µä¸‹çŠ¶æ€ä¸åŒæ­¥ï¼‰
            setInterval(() => {
                checkLoginStatus();
            }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡

            // é¡µé¢è·å¾—ç„¦ç‚¹æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
            window.addEventListener('focus', () => {
                console.log('ğŸ”„ é¡µé¢è·å¾—ç„¦ç‚¹ï¼Œæ£€æŸ¥ç™»å½•çŠ¶æ€...');
                setTimeout(checkLoginStatus, 100);
            });

            // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    console.log('ğŸ”„ é¡µé¢å˜ä¸ºå¯è§ï¼Œæ£€æŸ¥ç™»å½•çŠ¶æ€...');
                    setTimeout(checkLoginStatus, 100);
                }
            });
        }

        // åˆå§‹åŒ–è®¤è¯ç®¡ç†å™¨
        function initAuthManager() {
            // è®¾ç½®ç™»å½•æˆåŠŸåçš„é‡å®šå‘URLä¸ºå½“å‰é¡µé¢
            if (window.authManager) {
                window.authManager.setRedirectUrl(window.location.href);
            }
        }

        // æ£€æŸ¥å¹¶ä¿æŒç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            console.log('ğŸ” æ£€æŸ¥ç™»å½•çŠ¶æ€...');

            // æ£€æŸ¥å¤šç§ç™»å½•çŠ¶æ€å­˜å‚¨æ–¹å¼
            let isLoggedIn = false;
            let username = '';

            // æ–¹å¼1ï¼šæ£€æŸ¥authManager
            if (window.authManager && typeof window.authManager.isLoggedIn === 'function') {
                isLoggedIn = window.authManager.isLoggedIn();
                if (isLoggedIn && window.authManager.getCurrentUser) {
                    const user = window.authManager.getCurrentUser();
                    username = user ? user.username : '';
                }
                console.log('ğŸ“‹ AuthManageræ£€æŸ¥ç»“æœ:', isLoggedIn, username);
            }

            // æ–¹å¼2ï¼šæ£€æŸ¥localStorage
            if (!isLoggedIn && localStorage.getItem('isLoggedIn') === 'true') {
                isLoggedIn = true;
                username = localStorage.getItem('username') || '';
                console.log('ğŸ’¾ LocalStorageæ£€æŸ¥ç»“æœ:', isLoggedIn, username);
            }

            // æ–¹å¼3ï¼šæ£€æŸ¥sessionStorage
            if (!isLoggedIn) {
                const sessionUser = sessionStorage.getItem('currentUser');
                if (sessionUser) {
                    try {
                        const user = JSON.parse(sessionUser);
                        if (user && user.username) {
                            isLoggedIn = true;
                            username = user.username;
                            console.log('ğŸ—‚ï¸ SessionStorageæ£€æŸ¥ç»“æœ:', isLoggedIn, username);
                        }
                    } catch (e) {
                        console.log('è§£æsessionç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
                    }
                }
            }

            // æ–¹å¼4ï¼šæ£€æŸ¥userInfo
            if (!isLoggedIn) {
                const userInfo = localStorage.getItem('userInfo');
                if (userInfo) {
                    try {
                        const user = JSON.parse(userInfo);
                        if (user && user.username) {
                            isLoggedIn = true;
                            username = user.username;
                            console.log('ğŸ“„ UserInfoæ£€æŸ¥ç»“æœ:', isLoggedIn, username);
                        }
                    } catch (e) {
                        console.log('è§£æuserInfoå¤±è´¥:', e);
                    }
                }
            }

            console.log('âœ… æœ€ç»ˆç™»å½•çŠ¶æ€:', isLoggedIn, username);

            // æ›´æ–°UIæ˜¾ç¤º
            updateLoginUI(isLoggedIn, username);
        }

        // æ›´æ–°ç™»å½•UIæ˜¾ç¤º
        function updateLoginUI(isLoggedIn, username) {
            console.log('ğŸ¨ å¼€å§‹æ›´æ–°UIï¼ŒçŠ¶æ€:', isLoggedIn, 'ç”¨æˆ·å:', username);

            const loggedInMenu = document.getElementById('userMenuLoggedIn');
            const loggedOutMenu = document.getElementById('userMenuLoggedOut');
            const usernameDisplay = document.getElementById('usernameDisplay');

            console.log('ğŸ” UIå…ƒç´ æ£€æŸ¥:', {
                loggedInMenu: !!loggedInMenu,
                loggedOutMenu: !!loggedOutMenu,
                usernameDisplay: !!usernameDisplay
            });

            if (isLoggedIn && username) {
                // æ˜¾ç¤ºå·²ç™»å½•çŠ¶æ€
                if (loggedInMenu) {
                    loggedInMenu.style.display = 'flex';
                    console.log('âœ… æ˜¾ç¤ºå·²ç™»å½•èœå•');
                }
                if (loggedOutMenu) {
                    loggedOutMenu.style.display = 'none';
                    console.log('âœ… éšè—æœªç™»å½•èœå•');
                }
                if (usernameDisplay) {
                    usernameDisplay.textContent = username;
                    console.log('âœ… è®¾ç½®ç”¨æˆ·åæ˜¾ç¤º:', username);
                }

                console.log('ğŸ‰ å·²ç™»å½•çŠ¶æ€UIæ›´æ–°å®Œæˆ:', username);
            } else {
                // æ˜¾ç¤ºæœªç™»å½•çŠ¶æ€
                if (loggedInMenu) {
                    loggedInMenu.style.display = 'none';
                    console.log('âœ… éšè—å·²ç™»å½•èœå•');
                }
                if (loggedOutMenu) {
                    loggedOutMenu.style.display = 'flex';
                    console.log('âœ… æ˜¾ç¤ºæœªç™»å½•èœå•');
                }

                console.log('ğŸ‘¤ æœªç™»å½•çŠ¶æ€UIæ›´æ–°å®Œæˆ');
            }
        }

        // ç»‘å®šé€€å‡ºç™»å½•äº‹ä»¶
        function bindLogoutEvent() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    logout();
                });
            }
        }

        // ç»‘å®šç™»å½•æ³¨å†Œé“¾æ¥äº‹ä»¶
        function bindAuthLinks() {
            const loginLink = document.getElementById('loginLink');
            const registerLink = document.getElementById('registerLink');

            console.log('ğŸ”— ç»‘å®šè®¤è¯é“¾æ¥...', { loginLink, registerLink });

            if (loginLink) {
                loginLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    // ä½¿ç”¨URLå‚æ•°æ–¹å¼ä¼ é€’é‡å®šå‘åœ°å€ï¼ˆæ›´å¯é ï¼‰
                    const currentUrl = encodeURIComponent(window.location.href);
                    const loginUrl = `../auth/login.html?redirect=${currentUrl}`;

                    console.log('ğŸ’¾ å½“å‰é¡µé¢URL:', window.location.href);
                    console.log('ğŸ”— ç™»å½•é¡µé¢URL:', loginUrl);

                    // åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ç”¨
                    localStorage.setItem('loginRedirectUrl', window.location.href);
                    console.log('ğŸ’¾ å¤‡ç”¨ä¿å­˜åˆ°localStorage');

                    // è·³è½¬åˆ°ç™»å½•é¡µé¢
                    console.log('ğŸš€ è·³è½¬åˆ°ç™»å½•é¡µé¢...');
                    window.location.href = loginUrl;
                });
            } else {
                console.warn('âš ï¸ æœªæ‰¾åˆ°ç™»å½•é“¾æ¥å…ƒç´ ');
            }

            if (registerLink) {
                registerLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    // ä½¿ç”¨URLå‚æ•°æ–¹å¼ä¼ é€’é‡å®šå‘åœ°å€ï¼ˆæ›´å¯é ï¼‰
                    const currentUrl = encodeURIComponent(window.location.href);
                    const registerUrl = `../auth/register.html?redirect=${currentUrl}`;

                    console.log('ğŸ’¾ å½“å‰é¡µé¢URL:', window.location.href);
                    console.log('ğŸ”— æ³¨å†Œé¡µé¢URL:', registerUrl);

                    // åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ç”¨
                    localStorage.setItem('loginRedirectUrl', window.location.href);
                    console.log('ğŸ’¾ å¤‡ç”¨ä¿å­˜åˆ°localStorage');

                    // è·³è½¬åˆ°æ³¨å†Œé¡µé¢
                    console.log('ğŸš€ è·³è½¬åˆ°æ³¨å†Œé¡µé¢...');
                    window.location.href = registerUrl;
                });
            } else {
                console.warn('âš ï¸ æœªæ‰¾åˆ°æ³¨å†Œé“¾æ¥å…ƒç´ ');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            console.log('ğŸšª å¼€å§‹é€€å‡ºç™»å½•...');

            // å¦‚æœæœ‰authManagerï¼Œä¼˜å…ˆä½¿ç”¨å…¶é€€å‡ºæ–¹æ³•
            if (window.authManager && typeof window.authManager.logout === 'function') {
                window.authManager.logout();
            } else {
                // æ‰‹åŠ¨æ¸…ç†æ‰€æœ‰ç™»å½•ç›¸å…³çš„å­˜å‚¨
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('username');
                localStorage.removeItem('userInfo');
                sessionStorage.removeItem('currentUser');

                console.log('ğŸ§¹ æ‰‹åŠ¨æ¸…ç†ç™»å½•çŠ¶æ€å®Œæˆ');
            }

            // æ›´æ–°UIä¸ºæœªç™»å½•çŠ¶æ€
            updateLoginUI(false, '');

            // å¯é€‰ï¼šæ˜¾ç¤ºé€€å‡ºæˆåŠŸæ¶ˆæ¯
            console.log('âœ… é€€å‡ºç™»å½•æˆåŠŸï¼Œåœç•™åœ¨å½“å‰é¡µé¢');
        }

        // æµ‹è¯•å¯è§†åŒ–åŠŸèƒ½
            console.log('ğŸ§ª å¼€å§‹æµ‹è¯•å¯è§†åŒ–åŠŸèƒ½');

            // æ¨¡æ‹Ÿæœç´¢ç»“æœæ•°æ®
            const mockData = {
                success: true,
                database: 'pubmed',
                method: 'test',
                count: 20,
                details: []
            };

            // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
            for (let i = 0; i < 20; i++) {
                mockData.details.push({
                    title: `Test Article ${i + 1}: Machine Learning in Bioinformatics`,
                    year: 2018 + Math.floor(Math.random() * 6),
                    authors: ['Smith J', 'Johnson A', 'Brown K'],
                    journal: 'Nature Biotechnology',
                    abstract: 'This is a sample abstract for testing visualization purposes...',
                    pmid: `12345${i}`,
                    url: '#'
                });
            }

            // è·å–å…¨å±€æœç´¢å®ä¾‹å¹¶æ˜¾ç¤ºç»“æœ
            if (window.bioinfoSearchInstance) {
                window.bioinfoSearchInstance.displayResults(mockData);
            } else {
                console.error('âŒ æœç´¢å®ä¾‹æœªæ‰¾åˆ°');
            }
        }

        // æ·»åŠ æµ‹è¯•æŒ‰é’®åˆ°é¡µé¢
            const searchButtons = document.querySelector('.search-buttons');
            if (searchButtons) {
                testBtn.className = 'search-btn';
                testBtn.style.marginLeft = '10px';
                testBtn.innerHTML = '<i class="fas fa-flask"></i> æµ‹è¯•å¯è§†åŒ–';
                searchButtons.appendChild(testBtn);
            }
        }

        // ä¿®å¤å›¾è¡¨é«˜åº¦çš„å‡½æ•°
        function fixChartHeights() {
            console.log('ğŸ”§ ä¿®å¤å›¾è¡¨é«˜åº¦...');

            // ä¿®å¤æ‰€æœ‰Canvaså…ƒç´ 
            document.querySelectorAll('.chart-canvas-wrapper canvas').forEach(canvas => {
                canvas.style.height = '420px';
                canvas.style.width = '100%';
                if (canvas.parentElement) {
                    canvas.parentElement.style.height = '420px';
                }
            });

            // ä¿®å¤D3å’ŒPlotlyå®¹å™¨
            document.querySelectorAll('.d3-container, .plotly-container').forEach(container => {
                container.style.height = '420px';
                container.style.width = '100%';
            });

            console.log('âœ… å›¾è¡¨é«˜åº¦ä¿®å¤å®Œæˆ');
        }

        // æ·»åŠ æœç´¢é¡µé¢ä¸“ç”¨çš„çŒ«å’ªèœå•åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', () => {
            // æ·»åŠ æµ‹è¯•æŒ‰é’®

            // ä¿®å¤å›¾è¡¨é«˜åº¦
            setTimeout(fixChartHeights, 1000);
            const pixelCatMenu = document.getElementById('pixel-cat-menu');
            if (pixelCatMenu) {
                pixelCatMenu.addEventListener('click', (e) => {
                    const action = e.target.closest('.pixel-menu-item')?.dataset.action;
                    if (action) {
                        switch (action) {
                            case 'home':
                                window.location.href = '../index.html';
                                break;
                            case 'top':
                                window.scrollTo({ top: 0, behavior: 'smooth' });
                                break;
                            case 'focus':
                                document.getElementById('keyword').focus();
                                break;
                            case 'theme':
                                document.getElementById('themeToggle')?.click();
                                break;
                        }
                    }
                });
            }
        });
    </script>

    <!-- çº¯GIFæ¡Œå®  -->
    <script src="../pet/pixel-cat.js"></script>
</body>
</html>
